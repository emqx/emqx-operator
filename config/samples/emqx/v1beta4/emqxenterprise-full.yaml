apiVersion: apps.emqx.io/v1beta4
kind: EmqxEnterprise
metadata:
  name: emqx-ee
  labels:
    "apps.emqx.io/instance": "emqx-ee"
  annotations:
    service.beta.kubernetes.io/backend-type: "eni"
spec:
  replicas: 3
  license:
    # stringData:
    data: 
      LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUVLakNDQXhLZ0F3SUJBZ0lERzV6Wk1BMEdDU3FHU0liM0RRRUJDd1VBTUlHRE1Rc3dDUVlEVlFRR0V3SkQKVGpFUk1BOEdBMVVFQ0F3SVdtaGxhbWxoYm1jeEVUQVBCZ05WQkFjTUNFaGhibWQ2YUc5MU1Rd3dDZ1lEVlFRSwpEQU5GVFZFeEREQUtCZ05WQkFzTUEwVk5VVEVTTUJBR0ExVUVBd3dKS2k1bGJYRjRMbWx2TVI0d0hBWUpLb1pJCmh2Y05BUWtCRmc5NmFHRnVaM2RvUUdWdGNYZ3VhVzh3SGhjTk1qTXdNekEzTURVMU5ESTRXaGNOTWpNd05qQTEKTURVMU5ESTRXakJOTVFzd0NRWURWUVFHRXdKRFRqRU1NQW9HQTFVRUNnd0RSVTFSTVF3d0NnWURWUVFEREFORgpUVkV4SWpBZ0Jna3Foa2lHOXcwQkNRRVdFMk5zYjNWa2JtRjBhWFpsUUdWdGNYZ3VhVzh3Z2dFaU1BMEdDU3FHClNJYjNEUUVCQVFVQUE0SUJEd0F3Z2dFS0FvSUJBUURBV0djN3RNUllZYnVHbnlJWDk2OGdvQkIyZG11ck9pQWIKV0hBS3o5aUR1V1RhdlQ5NjloUHMvcE05anFTdFVuZk5mRXZzWHExeldLbEtzVmp1WWNnNFNPVDFpTjJ1cXRPQwowdXBsanVaV1hlOFlIYVdvV3lqcXNPdnl2di9qVTVwT3pwMFlDamtoQUZRb0E3NnZiK1p1T3dKcjY1WG5MRGV6CjRGazlWeGRmOU5IUTJ5YmFQQ3pkUktoY2ViaVBvYmdKeFV4WmY0bWEvRjFsWHc2TlMyQ1hXcDNOSlFQYlludlYKWVBxWGJWM2lybUpkYW5iTXdSM3lWY3pDVjRMZWNkV0pUbFpscGR0NHh6S1dXWm5YZ3RyZDBrbDZTenRkV3B4bApjQTBSYmJ5TTFRQ1JMbWowbzJGUW4rMVhvSXMrQ2RuSEVZTkt0QzQrQzRic3AweGNXWG8vQWdNQkFBR2pnZHN3CmdkZ3dGQVlKS3dZQkJBR0RtaDBCQkFjTUJUSXdNREF3TUlHYUJna3JCZ0VFQVlPYUhRSUVnWXdNZ1lsbGJYRjQKWDJKaFkydGxibVJmY21Wa2FYTXNJR1Z0Y1hoZlltRmphMlZ1WkY5dGVYTnhiQ3dnWlcxeGVGOWlZV05yWlc1awpYM0JuYzNGc0xDQmxiWEY0WDJKaFkydGxibVJmYlc5dVoyOHNJR1Z0Y1hoZlltRmphMlZ1WkY5allYTnpZU3dnClpXMXhlRjlpY21sa1oyVmZhMkZtYTJFc0lHVnRjWGhmWW5KcFpHZGxYM0poWW1KcGREQVFCZ2tyQmdFRUFZT2EKSFFNRUF3d0JNREFSQmdrckJnRUVBWU9hSFFRRUJBd0NMVEV3RFFZSktvWklodmNOQVFFTEJRQURnZ0VCQUEyeApVR2FOSmJFek96eDlNRXI0d2xwZ09PUUtQUytNamg5S1didmxnb2hYL0NTZjBXdzlzVUFBdlFxbmV6WTliRGdECmdKb3ZENktJSG1uaFdDOUJjbmhkbFd2NFF0SUJtN3hKYWwxSnR2cVMrcnk2N04xZnR2MUtWUG9OcHpuYXN0bXgKSElnTEFBb1lRWWpKeG9id0tvYXl1OWJaWmNKMTEvLzJTU2EwUUNjWGI3MWF5L1l2NjVqNVZOVk9xQ0pCT05QMAp4aHJxbFU5NGhQMjZUdnhiYXJJM0lVMXVvdldBQ09SZDYyY1JaMWx2YXMwYzNSNnFvL1R3K1NjTjBSYm9iOVVTCnN2WWNqRzBOZHJOYmVQb3BUeHluMVlDSTZIc2ZXRnY4ZVJSRmVZV0cyUzIvTEV5SDlpeXlkSkRIcXRSNnZNLzQKMUF0WnV3NXUxeHRHZUI0dnB6OD0KLS0tLS1FTkQgQ0VSVElGSUNBVEUtLS0tLQo=
  # persistent:
  #   metadata:
  #     name: emqx-ee
  #     labels:
  #       "apps.emqx.io/instance": "emqx-ee"
  #   spec:
  #     storageClassName: standard
  #     resources:
  #       requests:
  #         storage: 20Mi
  #     accessModes:
  #       - ReadWriteOnce
  # blueGreenUpdate:
  #   initialDelaySeconds: 30
  #   evacuationStrategy:
  #     waitTakeover: 10
  #     connEvictRate: 200
  #     sessEvictRate: 200
  template:
    metadata:
      labels:
        "apps.emqx.io/instance": "emqx-ee"
      annotations:
        foo: bar
    spec:
      # imagePullPolicy: [fake-secret]
      # nodeName:
      # nodeSelector:
      # affinity:
      # tolerations:
      emqxContainer:
        image:
          repository: emqx/emqx-ee
          version: 4.4.15
        ports:
          - name: http-management
            containerPort: 8081
        emqxConfig:
          name: emqx-ee
          log.level: debug
          cluster.discovery: dns
          cluster.dns.type: srv
          cluster.dns.app: emqx-ee
          cluster.dns.name: emqx-ee-headless.default.svc.cluster.local
          listener.tcp.external: "1883"
          sysmon.long_schedule: 240h
        emqxACL:
          - "{allow, all}."
        #bootstrapAPIKeys:
        #  - key: bootstrap_user_key
        #    secret: bootstrap_secret
      # extraContainers:
      #   - name: extra
      #     image: busybox:stable
      #     command:
      #       - /bin/sh
      #       - -c
      #       - |
      #         tail -f /dev/null
      # initContainers:
      #   - name: busybox
      #     image: busybox:stable
      #     securityContext:
      #       runAsUser: 0
      #       runAsGroup: 0
      #       capabilities:
      #         add:
      #         - SYS_ADMIN
      #         drop:
      #         - ALL
      #     command:
      #      - /bin/sh
      #      - -c
      #      - |
      #        mount -o remount rw /proc/sys
      #        sysctl -w net.core.somaxconn=65535
      #        sysctl -w net.ipv4.ip_local_port_range="1024 65535"
      #        sysctl -w kernel.core_uses_pid=0
      #        sysctl -w net.ipv4.tcp_tw_reuse=1
      #        sysctl -w fs.nr_open=1000000000
      #        sysctl -w fs.file-max=1000000000
      #        sysctl -w net.ipv4.ip_local_port_range='1025 65534'
      #        sysctl -w net.ipv4.udp_mem='74583000 499445000 749166000'
      #        sysctl -w net.ipv4.tcp_max_sync_backlog=163840
      #        sysctl -w net.core.netdev_max_backlog=163840
      #        sysctl -w net.core.optmem_max=16777216
      #        sysctl -w net.ipv4.tcp_rmem='1024 4096 16777216'
      #        sysctl -w net.ipv4.tcp_wmem='1024 4096 16777216'
      #        sysctl -w net.ipv4.tcp_max_tw_buckets=1048576
      #        sysctl -w net.ipv4.tcp_fin_timeout=15
      #        sysctl -w net.core.rmem_default=262144000
      #        sysctl -w net.core.wmem_default=262144000
      #        sysctl -w net.core.rmem_max=262144000
      #        sysctl -w net.core.wmem_max=262144000
      #        sysctl -w net.ipv4.tcp_mem='378150000  504200000  756300000'
      #        sysctl -w net.netfilter.nf_conntrack_max=1000000
      #        sysctl -w net.netfilter.nf_conntrack_tcp_timeout_time_wait=30

  serviceTemplate:
    metadata:
      name: emqx-ee
      namespace: default
      labels:
        "apps.emqx.io/instance": "emqx-ee"
    spec:
      type: NodePort
      selector:
        "apps.emqx.io/instance": "emqx-ee"
      ports:
        - name: "http-dashboard-18083"
          protocol: "TCP"
          port: 18083
          targetPort: 18083
        - name: "mqtt-tcp-1883"
          protocol: "TCP"
          port: 1883
          targetPort: 1883
          nodePort: 32001
